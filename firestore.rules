rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is an admin
    // This assumes admins have a field 'role' == 'admin' or 'super_admin' in the 'users' collection
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }

    // Helper: Verify data structure
    function isValidBooking() {
      let data = request.resource.data;
      return 
        // Must have a shareholder Name
        data.shareholderName is string && data.shareholderName.size() > 0 &&
        
        // Must have Dates
        data.from is timestamp &&
        data.to is timestamp &&
        data.createdAt is timestamp &&
        
        // Type must be booking or pass
        (data.type == 'booking' || data.type == 'pass') &&
        
        // Basic Logic
        data.to > data.from;
    }

    match /bookings/{bookingId} {
      // READ: Publicly readable (required for Dashboard)
      allow read: if true;

      // WRITE: Allow if authenticated AND validates schema
      allow create: if request.auth != null && isValidBooking();
      allow update: if request.auth != null && isValidBooking();
      
      // DELETE: Admins only
      allow delete: if isAdmin();
    }

    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if isAdmin();
    }

    match /notification_log/{logId} {
      allow read: if isAdmin();
      allow write: if request.auth != null;
    }

    match /status/draftStatus {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
